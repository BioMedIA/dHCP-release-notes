---
---

## Fetal diffusion SHARD pipeline

### Inputs

**From reconstruction pipeline:** `rawdata/sub-{subid}/ses-{sesid}`

| Description                                                                             | Filename                                                                  |
|:----------------------------------------------------------------------------------------|:--------------------------------------------------------------------------|
| Multi-band dMRI EPI (spin echo)                                                         | `dwi/sub-{subid}_ses-{sesid}_run-{seqnum}_rec-???.nii`                    |
| Multi-band dMRI EPI (field echo)                                                        | `dwi/sub-{subid}_ses-{sesid}_run-{seqnum}_rec-???.nii`                    |


### Outputs

The primary outputs of the full SHARD preprocessing pipeline are:

| Description                                                                  | Filename                                                                |
|------------------------------------------------------------------------------|-------------------------------------------------------------------------|
| Preprocessed DWI data (denoising, motion correction, and destriping)         | `dwi/sub-{subid}_ses-{sesid}_desc-preproc_dwi.nii.gz`                   |
| List of b-values in FSL format                                               | `dwi/sub-{subid}_ses-{sesid}_desc-preproc_dwi.bval`                     |
| List of gradient directions in FSL format                                    | `dwi/sub-{subid}_ses-{sesid}_desc-preproc_dwi.bvec`                     |

(located in `derivatives/dhcp_dmri_shard_pipeline/sub-{subid}/ses-{sesid}`)

The complete list of outputs and QC reports generated by the diffusion SHARD pipeline 
is listed in the [Diffusion SHARD pipeline](structure.html#diffusion-shard-pipeline) 
section of the directory structure summary.


### Pipeline

The fetal dMRI pipeline<sup>[3](#ref1)</sup> consists of the following 
processing steps:

1. Image denoising using random matrix theory with optimal
shrinkage in the complex domain (i.e., using magnitude and phase
images)<sup>[2](#ref2)</sup>. This denoising approach also accounts
for spatial noise correlations introduced by SENSE and Partial Fourier
subsampling. After denoising, the magnitude images are extracted.

2. The B0 field map, used to model susceptibility-induced distortion,
is estimated *dynamically* from the phase difference between spin echo and 
field echo (SAFE) images<sup>[3](#ref3)</sup>. The magnitude images are then
unwarped using sinc-interpolation.

3. The denoised and unwarped images are corrected for intensity inhomogeneity 
using static N4 bias field correction<sup>[4](#ref4)</sup>. The bias field is 
estimated based on the mean spin echo b=0 image (before motion correction) and 
multiplicatively applied to all spin echo and field echo volumes.

4. Motion correction using SHARD slice-to-volume 
reconstruction<sup>[5](#ref5)</sup>. The inputs are the unwarped and bias field 
corrected spin echo and field echo dMRI images (stage 3). The output are 
estimated subject motion traces, slice weights used to correct dropouts, and 
the SHARD representation fitted to the scattered slice data of the spin echo 
and field echo images. The motion- and distortion-corrected image is stored as 
a series of Spherical Harmonics (SH) coefficients for each shell.

5. The 5D SHARD output image is projected onto the original diffusion encoding
used during acquisition, to provide the dMRI output in a format compatible with
conventional software. This is a one-to-one mapping representing identical
image information. Note that motion-induced gradient reorientation is modelled
during SHARD slice-to-volume reconstruction in step 4; the gradient table
hence remains unchanged.

6. **TODO** Rigid alignement to high-resolution structural (T2-weighted) space
using normalised mutual information (NMI) based registration with FSL
Flirt <sup>[8](#ref8)</sup>on the mean b=1000 s/mm<sup>2</sup> shell. This
transformation is combined with a non-linear registration<sup>[9](#ref9)</sup>
of the T2w volume to the 40 weeks template<sup>[10](#ref10)</sup> to allow
transformations between diffusion and atlas spaces.

<a name="shard-qc"></a>
### Diffusion MRI QC

Automated quality control metrics are calculated for several key steps in
the pipeline. Specifically, the data release includes estimates of:

- **Signal-to-Noise Ratio**: A measure of SNR is calculated based on the
  residuals of denoising (Step 1). The reported metrics are the median
  across a brain mask of the RMS residuals, divided by the median of the
  mean b=0 signal.

- **Motion metrics**: Measures of the mean translation and rotation that was
  detected/estimated in the motion correction method.<sup>[5](#ref5)</sup>
  These metrics are based on the gradient of the motion trace, thus measuring
  the subject activity during the scan.

- **Outlier ratio**: The mean outlier weight of all slices in the data, as
  detected in slice-to-volume reconstruction.<sup>[5](#ref5)</sup>

In addition, overview screenshots of the motion traces and destriped output
data are generated. Based on these screenshots, visual pass/fail Quality
Control identified a small subset of cases to be discarded from analysis.

All QC metrics are available in the `combined.tsv` spreadsheet in the
[supplementary](https://github.com/BioMedIA/dHCP-release-notes/tree/master/supplementary_files).


### References

<a name="ref1"/>1. Christiaens, D., Cordero-Grande, L., Price, A.N.,
Hutter, J., Hughes, E.J., Counsell, S.J., Tournier, J-D., Hajnal, J.V. **Fetal
diffusion MRI acquisition and analysis in the developing Human Connectome
Project** *ISMRM 2019, 0629.* [abstract](http://archive.ismrm.org/2019/0629.html)

<a name="ref2"/>2. Cordero-Grande, L., Christiaens, D., Hutter, J., Price,
A.N., Hajnal, J.V.  **Complex diffusion-weighted image estimation via matrix
recovery under general noise models** *Neuroimage (2019), 200: 391-404.* [DOI:
10.1016/j.neuroimage.2019.06.039](https://doi.org/10.1016/j.neuroimage.2019.06.039)

<a name="ref3"/>3. Cordero-Grande, L., Price. A.N., Ferrazzi, G., Hutter, J.,
Christiaens, D., Hughes, E., Hajnal, J. **Spin And Field Echo (SAFE) dynamic 
field correction in 3T fetal EPI.** *ISMRM 2018, 0208.* 
[abstract](http://archive.ismrm.org/2018/0208.html)

<a name="ref4"/>4. Tustison, N.J., Avants, B.B., Cook, P.A., Zheng, Y., Egan, 
A., Yushkevich, P.A., Gee, J.C. **N4ITK: improved N3 bias correction** *IEEE 
Trans Med Imaging (2010), 29(6): 1310-20* [DOI: 
10.1109/TMI.2010.2046908](https://doi.org/10.1109/TMI.2010.2046908)

<a name="ref5"/>5. Christiaens, D., Cordero-Grande, L., Pietsch, M.,
Hutter, J., Price, A.N., Hughes, E.J., Vecchiato, K., Deprez, M., Edwards,
A.D., Hajnal, V., Tournier, J-D.  **Scattered slice SHARD reconstruction
for motion correction in multi-shell diffusion MRI** *NeuroImage (2021),
225: 117437.* [DOI:
 10.1016/j.neuroimage.2020.117437](https://doi.org/10.1016/j.neuroimage.2020.117437)



<a name="ref8"/>8. Jenkinson, M., Bannister, P., Brady, M., and Smith,
S. **Improved optimization for the robust and accurate linear registration
and motion correction of brain image** *Neuroimage (2002), 17(2): 825-841.*
[DOI: 10.1006/nimg.2002.1132](https://doi.org/10.1006/nimg.2002.1132)

<a name="ref9"/>9. Andersson, J.L.R., Jenkinson,
M., and Smith, S. [**Non-linear registration, aka spatial
normalisation**](https://www.fmrib.ox.ac.uk/datasets/techrep/tr07ja2/tr07ja2.pdf)
*FMRIB technical report TR07JA2 (2010).*

<a name="ref10"/>10. Schuh, A., Makropoulos, A., Robinson, E.C.,
Cordero-Grande, L., Hughes, E., Hutter, J., Price, A.N., Murgasova,
M., Teixeira, R.P.A.G., Tusor, N., Steinweg, J.K., Victor, S.,
Rutherford, M.A., Hajnal, J.V., Edwards, A.D., and Rueckert,
D. **Unbiased construction of a temporally consistent morphological
atlas of neonatal brain development** *bioRxiv (2018), 251512.* [DOI:
10.1101/251512](https://doi.org/10.1101/251512)



